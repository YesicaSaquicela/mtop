<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:c="http://java.sun.com/jsp/jstl/core">
    <ui:composition template="/WEB-INF/view/templates/glue.xhtml">
        <ui:define name="header-replace" >
            <div class="header-replace">            
                <div class="container-header">                
                    <div class="row lf row-title" > 
                        <h2>#{messages['receta.admin']}</h2>   
                    </div> 
                </div>   
            </div>  

        </ui:define>

        <ui:define name="content">           
            <!--Metadato que se realiza antes de renderizarse la vista-->
            <f:metadata>
                <f:viewParam name="pacienteId" value="#{RecetaHome.pacienteId}" />
                <f:viewParam name="consultaMedicaId" value="#{Receta.consultaMedicaId}" />
                <f:viewParam name="backView" value="#{fichaMedicaHome.backView}" />
            </f:metadata>
            <!--Formulario dentro de un contenedor-->
            <h:form id="form">            
                <!--Opción de mensaje, cuando se realiza una acción dfghdh-->
                <!--para mostrar mensaje de componentes seleccionados y errores si fuera el caso-->
                <p:messages id="messages" showDetail="true" autoUpdate="true" closable="true" />  

                <!--Botones de admin-->
                <div class="admin-actions">                    
                        <!--<h:link value="#{messages['common.add']}" rendered="#{true}" outcome="receta" styleClass="btn primary">
                            <f:param name="pacienteId"></f:param>
                            <f:param name="backView" value="lista"></f:param>
                        </h:link>
                    #{' '}
                    <h:link id="button-edit" value="#{messages['common.edit']}" rendered="#{true}" outcome="medicamento" styleClass="btn" 
                            disabled="#{empty recetaListaServicio.recetaSeleccionada }">
                        <f:param name="recetaId" value="#{recetaListaServicio.recetaSeleccionada.id}"></f:param>
                        <f:param name="backView" value="lista"></f:param>
                    </h:link>-->
                    <p:commandButton id="button-edit" value="#{messages['receta.entrega']}" styleClass="btn primary"
                                     onclick="#{'editDlg.show();'}" ajax="true" disabled="#{empty recetaListaServicio.recetaSeleccionada}">
                        <p:ajax process="@this" update=":edit-dialog"/>
                    </p:commandButton>
                    &nbsp;&nbsp;
                    <p:commandLink id="button-print" value="#{messages['common.print']}" styleClass="btn primary" action="#{reporteReceta.renderReceta()}"
                                   disabled="#{empty recetaListaServicio.recetaSeleccionada}" rendered="true" immediate="true">
                        <f:param name="medicaciones" value="#{recetaListaServicio.recetaSeleccionada.medicaciones}" rendered="true"/>
                        <f:param name="indicaciones" value="#{recetaListaServicio.recetaSeleccionada.indicaciones}" rendered="true"/>
                        <f:param name="nombres" value="#{recetaListaServicio.recetaSeleccionada.paciente.nombres}" rendered="true"/>
                        <f:param name="apellidos" value="#{recetaListaServicio.recetaSeleccionada.paciente.apellidos}" rendered="true"/>
                        <f:param name="recetaId" value="#{recetaListaServicio.recetaSeleccionada.id}" rendered="true"/>
                    </p:commandLink>

                    <div style="float: right" >
                        <p:inputText id="criterioBuscar" size ="25" value="#{recetaListaServicio.parametroBusqueda}" title="Ingrese un criterio de busqueda">
                            <p:ajax event="keyup" update="tablaRecetas"/>
                        </p:inputText>
                        &nbsp;
                        <p:commandButton value="Buscar" action="#{recetaListaServicio.buscarPorParametro()}" update="tablaRecetas" styleClass="btn info"/>                    
                    </div>
                </div>                
                <p:dataTable id="tablaRecetas"  var="receta_" value="#{recetaListaServicio.resultList}"
                             paginator="true" rows="20"  paginatorPosition="top"
                             paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {RowsPerPageDropdown} {NextPageLink} {LastPageLink} "
                             rowsPerPageTemplate="5,10,20,50,100"
                             lazy="true" rowKey="#{receta_.id}"
                             selection="#{recetaListaServicio.recetaSeleccionada}"                             
                             selectionMode="single">
                    <!--Acciones Ajax, que me permiten seleccionar y desseleccionar un paciente-->
                    <p:ajax event="rowSelect" listener="#{recetaListaServicio.onRowSelect}"
                            update=":form:button-edit :form:messages :form:button-print :edit-dialog"/>   
                    <p:ajax event="rowUnselect" listener="#{recetaListaServicio.onRowUnselect}" 
                            update=":form:button-edit :form:messages :form:button-print :edit-dialog"/>
                    <!--Columnas para mostrar en la tabla-->

                    <p:column sortBy="#{receta_.id}" style="width: 10%; text-align: center;">
                        <f:facet name="header">  
                            <h:outputText value="#{messages['fichaMedica.numero']}" />  
                        </f:facet>  
                        <h:outputText value="#{receta_.consultaMedica.historiaClinica.fichaMedica.numFicha}" rendered="#{receta_.consultaMedica.persistent}"/>                        
                        <h:outputText value="#{receta_.consultaOdontologica.fichaOdontologica.fichaMedica.numFicha}" rendered="#{receta_.consultaOdontologica.persistent}"/>                        
                    </p:column>
                    <p:column sortBy="#{receta_.paciente.nombres}" style="text-align: center;">
                        <f:facet name="header">  
                            <h:outputText value="Paciente" />  
                        </f:facet> 
                        <h:outputText value="#{receta_.paciente.nombres}" />
                        &nbsp;&nbsp;
                        <h:outputText value="#{receta_.paciente.apellidos}" />
                    </p:column>
                    <p:column sortBy="#{receta_.fechaEmision}" style="text-align: center;">
                        <f:facet name="header">  
                            <h:outputText value="#{messages['fechaReceta.fechaEmision']}" />  
                        </f:facet> 
                        <h:outputText value="#{receta_.fechaEmision}" >
                            <f:convertDateTime locale="es" pattern="dd-MMM-yyyy"/>
                        </h:outputText>
                        
                    </p:column>
                    <p:column sortBy="#{receta_.fechaEntrega}" style="text-align: center;">
                        <f:facet name="header">  
                            <h:outputText value="#{messages['fechaReceta.fechaEntrega']}" />  
                        </f:facet> 
                        <h:outputText value="#{receta_.fechaEntrega}" >
                            <f:convertDateTime locale="es" pattern="dd-MMM-yyyy"/>
                        </h:outputText>
                        
                    </p:column>
                    <p:column sortBy="#{receta_.responsableEmision}" style="text-align: center;">
                        <f:facet name="header">  
                            <h:outputText value="#{messages['receta.responsableEmision']}" />  
                        </f:facet>                         
                        <h:outputText value="#{receta_.responsableEmision.fullName}" />                            
                    </p:column>

                    <p:column sortBy="#{receta_.responsableEntrega}" style="text-align: center;">
                        <f:facet name="header">  
                            <h:outputText value="#{messages['receta.responsableEntrega']}" />  
                        </f:facet> 
                        <h:outputText value="#{receta_.responsableEntrega.fullName}" />                        
                    </p:column>
                    <p:column sortBy="#{receta_.estado}" style="text-align: center;">
                        <f:facet name="header">  
                            <h:outputText value="#{'receta.estado'}" />  
                        </f:facet> 
                        <h:outputText value="#{receta_.estado}" />
                    </p:column>                    
                </p:dataTable>
                
                <h:panelGrid id="export" class="columns" >
                <p:panel>
                    <h:outputText value="Exportar Datos" />  
                    <br/>
                    <h:commandLink action="#{reporteListas.renderRecetas()}" >                    
                        <p:graphicImage value="/resources/images/pdf.png" />                          
                    </h:commandLink>
                    #{''}
                    <h:commandLink >  
                        <p:graphicImage value="/resources/images/xls1.png" />  
                        <p:dataExporter type="xls" target="tablaRecetas" fileName="Recetas"/>  
                    </h:commandLink>
                </p:panel>
            </h:panelGrid>
            </h:form>
            <p:dialog id="edit-dialog" appendToBody="true" header="#{messages['receta.entrega']} #{messages['receta.nombre']} " 
                      widgetVar="editDlg" modal="true" resizable="true" dynamic="true" width="70%">
                <h:form id="form-dialog">

                    <p:panelGrid columns="4">
                        <label for="nombres" >#{messages['common.firstname']}: </label>                        
                        <h:outputText value="#{recetaListaServicio.recetaSeleccionada.paciente.nombres}" />                                                
                        <label for="numero" >#{messages['fichaMedica.numero']}: </label>                        
                        <h:panelGroup >
                            <h:outputText value="#{recetaListaServicio.recetaSeleccionada.consultaMedica.historiaClinica.fichaMedica.numFicha}" rendered="#{recetaListaServicio.recetaSeleccionada.consultaMedica.persistent}"/>                        
                            <h:outputText value="#{recetaListaServicio.recetaSeleccionada.consultaOdontologica.fichaOdontologica.fichaMedica.numFicha}" rendered="#{recetaListaServicio.recetaSeleccionada.consultaOdontologica.persistent}"/>                        
                        </h:panelGroup>                        
                        <label for="apellidos" >#{messages['common.surname']}: </label>
                        <h:outputText value="#{recetaListaServicio.recetaSeleccionada.paciente.apellidos}" />
                        <label for="fecha" >#{messages['comun.fecha.now']}: </label>                        
                        <h:outputText value="#{recetaListaServicio.recetaSeleccionada.fecha}" >
                            <f:convertDateTime locale="es" pattern="dd-MMM-yyyy"/>
                        </h:outputText>                                                
                    </p:panelGrid>
                    <p:panelGrid columns="2">
                        <p:panel header="Medicación" >
                            <c:forEach items="#{recetaListaServicio.listaMedicaciones}" var="med">
                                <h:outputText value="#{med}" escape="false" styleClass="span5"/>
                                <br/>
                                <br/>
                            </c:forEach>
                        </p:panel>                              

                        <p:panel header="Indicaciones">
                            <c:forEach items="#{recetaListaServicio.listaIndicaciones}" var="indi">
                                <h:outputText value="#{indi}" escape="false" styleClass="span5"/>   
                                <br/><br/>
                            </c:forEach>
                        </p:panel>
                    </p:panelGrid>                    
                    <div class="admin-actions">
                        <p:commandButton value="#{messages['comun.terminar']}" oncomplete="editDlg.hide();"                                           
                                         action="#{recetaListaServicio.entregarReceta()}" update=":form"                                         
                                         immediate="true" 
                                         style="margin: 0 0 0 30%">  
                                        <!--recetaListaServicio.entregarReceta()--> 
                        </p:commandButton> 
                        &nbsp;&nbsp;

                        &nbsp;&nbsp;
                        <p:commandButton value="#{messages['common.cancel']}" type="button" onclick="editDlg.hide();"  
                                         /> 
                    </div>
                </h:form>
            </p:dialog>
        </ui:define>

    </ui:composition>

</html>

